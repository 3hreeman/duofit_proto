<!DOCTYPE html>
<html>
<head>
    <title>사용자 관리</title>
    <style>
        /* Basic styling for better presentation */
        body { font-family: sans-serif; margin: 2em; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        tr:hover { background-color: #f5f5f5; cursor: pointer; }
        tr.active { background-color: #e0e0e0; }
        form { margin-bottom: 2em; }
        label { display: inline-block; width: 80px; }
        input { margin-bottom: 0.5em; }
        .buttons { margin-top: 1em; }
    </style>
</head>
<body>

    <h1>사용자 관리 (Cloud Ver.)</h1>

    <form id="userForm">
        <input type="hidden" id="userId" name="userId">
        <div>
            <label for="name">이름:</label>
            <input type="text" id="name" name="name" required>
        </div>
        <div>
            <label for="age">나이:</label>
            <input type="number" id="age" name="age" required>
        </div>
        <div>
            <label for="height">키(cm):</label>
            <input type="number" id="height" name="height" required>
        </div>
        <div>
            <label for="weight">몸무게(kg):</label>
            <input type="number" id="weight" name="weight" required>
        </div>
        <div class="buttons">
            <button type="submit">저장</button>
            <button type="button" id="deleteButton">삭제</button>
            <button type="button" id="clearButton">새로 입력</button>
        </div>
    </form>

    <h2>사용자 목록</h2>
    <table id="userTable">
        <thead>
            <tr>
                <th>이름</th>
                <th>나이</th>
                <th>키(cm)</th>
                <th>몸무게(kg)</th>
            </tr>
        </thead>
        <tbody>
            <!-- User rows will be inserted here -->
        </tbody>
    </table>

    <!-- Make this a module to use import/export -->
    <script type="module">
        // Import the new Firestore-based functions
        import { loadUsers, saveUser, removeUser } from './storage.js';

        const userForm = document.getElementById('userForm');
        const userIdField = document.getElementById('userId');
        const nameField = document.getElementById('name');
        const ageField = document.getElementById('age');
        const heightField = document.getElementById('height');
        const weightField = document.getElementById('weight');
        const userTableBody = document.querySelector('#userTable tbody');
        const deleteButton = document.getElementById('deleteButton');
        const clearButton = document.getElementById('clearButton');

        // Function to clear the form and reset selection
        function clearForm() {
            userForm.reset();
            userIdField.value = '';
            deleteButton.disabled = true; // Disable delete button when no user is selected
            // Also remove active class from all rows
            document.querySelectorAll('#userTable tbody tr').forEach(row => {
                row.classList.remove('active');
            });
        }

        // Function to render the user list in the table
        async function displayUsers() {
            // Clear existing table rows
            userTableBody.innerHTML = '';
            // Load users from Firestore
            const users = await loadUsers();
            
            users.forEach(user => {
                const row = userTableBody.insertRow();
                row.setAttribute('data-id', user.id); // Store Firestore ID
                row.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.age}</td>
                    <td>${user.height}</td>
                    <td>${user.weight}</td>
                `;
                // Add click event to populate form for editing
                row.addEventListener('click', () => {
                    // Highlight the selected row
                    document.querySelectorAll('#userTable tbody tr').forEach(r => r.classList.remove('active'));
                    row.classList.add('active');

                    userIdField.value = user.id;
                    nameField.value = user.name;
                    ageField.value = user.age;
                    heightField.value = user.height;
                    weightField.value = user.weight;
                    deleteButton.disabled = false; // Enable delete button
                });
            });
        }

        // Handle form submission for saving/updating a user
        userForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const user = {
                id: userIdField.value || null, // Pass ID for updates, or null for new users
                name: nameField.value,
                age: ageField.value,
                height: heightField.value,
                weight: weightField.value
            };
            await saveUser(user);
            clearForm();
            await displayUsers(); // Refresh the list
        });

        // Handle user deletion
        deleteButton.addEventListener('click', async () => {
            const userId = userIdField.value;
            if (userId && confirm('정말로 이 사용자를 삭제하시겠습니까?')) {
                await removeUser(userId);
                clearForm();
                await displayUsers(); // Refresh the list
            }
        });
        
        // Handle clear button click
        clearButton.addEventListener('click', clearForm);

        // Initial load of users when the page loads
        async function initialize() {
            clearForm();
            await displayUsers();
        }

        initialize();
    </script>

</body>
</html>