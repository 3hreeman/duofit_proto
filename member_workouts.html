<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DuoFit - 내 운동 기록</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="style.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="logo" href="member_dashboard.html">DUO<span class="logo-fit">FIT</span></a>
            <a href="index.html" id="logout-btn" class="btn btn-secondary btn-sm">로그아웃</a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">내 운동 기록</h2>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addWorkoutModal">
                <i class="bi bi-plus-lg"></i> 운동 추가
            </button>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs nav-fill mb-3" id="workoutTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab"><i class="bi bi-pie-chart-fill me-2"></i>오버뷰</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab"><i class="bi bi-list-ul me-2"></i>상세 기록</button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="workoutTabContent">
            <!-- Overview Tab Pane -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-body p-4">
                        <div class="row g-4">
                            <div class="col-lg-8">
                                <h5 class="card-title mb-3"><i class="bi bi-bar-chart-line-fill me-2"></i>일자별 총 볼륨</h5>
                                <canvas id="volumeChart"></canvas>
                            </div>
                            <div class="col-lg-4">
                                <h5 class="card-title mb-3"><i class="bi bi-broadcast-pin me-2"></i>부위별 운동 비율</h5>
                                <canvas id="partChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Details Tab Pane -->
            <div class="tab-pane fade" id="details" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-body">
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <select id="filter-part" class="form-select"><option value="all">모든 부위</option></select>
                            </div>
                            <div class="col-md-4">
                                <select id="filter-exercise" class="form-select"><option value="all">모든 운동</option></select>
                            </div>
                        </div>
                        <div id="workout-list" class="row g-4">
                            <!-- Filtered workout cards will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Workout Modal -->
    <div class="modal fade" id="addWorkoutModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content card">
                <form id="add-workout-form">
                    <div class="modal-header border-0">
                        <h5 class="modal-title">새 운동 기록 추가</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="form-floating mb-3">
                            <input type="date" class="form-control" id="workout-date" required>
                            <label for="workout-date">날짜</label>
                        </div>
                        <div class="form-floating mb-3">
                            <select class="form-select" id="workout-part-select" required></select>
                            <label for="workout-part-select">운동 부위</label>
                        </div>
                        <div class="form-floating mb-3">
                            <select class="form-select" id="workout-name-select" required></select>
                            <label for="workout-name-select">운동 이름</label>
                        </div>
                        <div class="row g-3">
                            <div class="col-sm-4"><div class="form-floating"><input type="number" class="form-control" id="workout-weight" placeholder="무게(kg)" required><label for="workout-weight">무게(kg)</label></div></div>
                            <div class="col-sm-4"><div class="form-floating"><input type="number" class="form-control" id="workout-reps" placeholder="횟수" required><label for="workout-reps">횟수</label></div></div>
                            <div class="col-sm-4"><div class="form-floating"><input type="number" class="form-control" id="workout-sets" placeholder="세트" required><label for="workout-sets">세트</label></div></div>
                        </div>
                    </div>
                    <div class="modal-footer border-0">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                        <button type="submit" class="btn btn-primary">저장</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="storage.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const currentUser = getCurrentUser();
            if (!currentUser) {
                alert('로그인이 필요합니다.');
                window.location.href = 'index.html';
                return;
            }

            const addWorkoutModal = new bootstrap.Modal(document.getElementById('addWorkoutModal'));
            const exercises = getExercises();
            const exerciseParts = getExerciseParts();
            let volumeChart, partChart;

            // Populate filter and modal dropdowns
            function populateDropdowns() {
                const partFilter = document.getElementById('filter-part');
                const exerciseFilter = document.getElementById('filter-exercise');
                const partModalSelect = document.getElementById('workout-part-select');
                const exerciseModalSelect = document.getElementById('workout-name-select');

                exerciseParts.forEach(part => {
                    partFilter.innerHTML += `<option value="${part}">${part}</option>`;
                    partModalSelect.innerHTML += `<option value="${part}">${part}</option>`;
                });

                function updateExerciseOptions(part, exerciseSelect) {
                    exerciseSelect.innerHTML = '<option value="all">모든 운동</option>';
                    exercises.filter(ex => part === 'all' || ex.part === part).forEach(ex => {
                        exerciseSelect.innerHTML += `<option value="${ex.id}">${ex.name}</option>`;
                    });
                }
                
                partFilter.addEventListener('change', () => updateExerciseOptions(partFilter.value, exerciseFilter));
                partModalSelect.addEventListener('change', () => {
                    exerciseModalSelect.innerHTML = '';
                    exercises.filter(ex => ex.part === partModalSelect.value).forEach(ex => {
                        exerciseModalSelect.innerHTML += `<option value="${ex.id}">${ex.name}</option>`;
                    });
                });
                updateExerciseOptions('all', exerciseFilter);
                if(exerciseParts.length > 0) partModalSelect.value = exerciseParts[0];
                partModalSelect.dispatchEvent(new Event('change'));
            }

            // Render workout cards in the details tab
            function renderWorkouts() {
                const workoutList = document.getElementById('workout-list');
                workoutList.innerHTML = '';
                const partFilter = document.getElementById('filter-part').value;
                const exerciseFilter = document.getElementById('filter-exercise').value;

                const filteredWorkouts = (currentUser.workouts || []).filter(w => 
                    (partFilter === 'all' || w.part === partFilter) && 
                    (exerciseFilter === 'all' || w.exerciseId === exerciseFilter)
                );

                if (filteredWorkouts.length === 0) {
                    workoutList.innerHTML = '<div class="col-12"><div class="card card-body text-center"><p class="mb-0">해당 조건의 운동 기록이 없습니다.</p></div></div>';
                    return;
                }

                filteredWorkouts.forEach(w => {
                    const el = document.createElement('div');
                    el.className = 'col-md-6 col-lg-4';
                    el.innerHTML = `
                        <div class="card h-100 interactive-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h5 class="card-title text-primary">${w.name}</h5>
                                        <h6 class="card-subtitle mb-2 text-muted">${w.date}</h6>
                                    </div>
                                    <button class="btn btn-sm btn-outline-danger delete-workout-btn" data-id="${w.id}"><i class="bi bi-trash"></i></button>
                                </div>
                                <p class="card-text mt-3">
                                    <span class="badge bg-primary">${w.part}</span><br><br>
                                    <strong>강도:</strong> ${w.weight}kg / ${w.reps}회 / ${w.sets}세트
                                </p>
                            </div>
                        </div>
                    `;
                    workoutList.appendChild(el);
                });
            }

            // Render overview charts
            function renderCharts() {
                try {
                    Chart.defaults.color = '#a0a0a0'; // Set default font color for charts

                    const workouts = currentUser.workouts || [];
                    
                    // 1. Volume Chart
                    const volumeCtx = document.getElementById('volumeChart');
                    if (volumeCtx) {
                        const volumeByDate = workouts.reduce((acc, w) => {
                            const volume = w.weight * w.reps * w.sets;
                            acc[w.date] = (acc[w.date] || 0) + volume;
                            return acc;
                        }, {});

                        if(volumeChart) volumeChart.destroy();
                        volumeChart = new Chart(volumeCtx, {
                            type: 'bar',
                            data: { labels: Object.keys(volumeByDate), datasets: [{ label: '총 볼륨 (kg)', data: Object.values(volumeByDate), backgroundColor: '#0d6efd' }] },
                            options: { scales: { y: { beginAtZero: true, grid: { color: '#444' } }, x: { grid: { color: '#444' } } } }
                        });
                    }

                    // 2. Part Chart
                    const partCtx = document.getElementById('partChart');
                    if (partCtx) {
                        const partCounts = workouts.reduce((acc, w) => {
                            acc[w.part] = (acc[w.part] || 0) + 1;
                            return acc;
                        }, {});

                        if(partChart) partChart.destroy();
                        partChart = new Chart(partCtx, {
                            type: 'doughnut',
                            data: { labels: Object.keys(partCounts), datasets: [{ data: Object.values(partCounts) }] },
                            options: { plugins: { legend: { labels: { color: '#a0a0a0' } } } }
                        });
                    }
                } catch (error) {
                    console.error("Chart rendering failed:", error);
                    // You could display a user-friendly error message here if needed
                }
            }

            // Event Listeners
            document.getElementById('add-workout-form').addEventListener('submit', e => {
                e.preventDefault();
                addWorkout(currentUser.id, {
                    date: document.getElementById('workout-date').value,
                    exerciseId: document.getElementById('workout-name-select').value,
                    weight: parseFloat(document.getElementById('workout-weight').value),
                    reps: parseInt(document.getElementById('workout-reps').value),
                    sets: parseInt(document.getElementById('workout-sets').value),
                });
                addWorkoutModal.hide();
                location.reload(); // Reload to reflect new data everywhere
            });

            document.getElementById('workout-list').addEventListener('click', e => {
                const deleteBtn = e.target.closest('.delete-workout-btn');
                if (deleteBtn && confirm('이 운동 기록을 삭제하시겠습니까?')) {
                    deleteWorkout(currentUser.id, deleteBtn.dataset.id);
                    location.reload();
                }
            });
            
            document.querySelectorAll('#filter-part, #filter-exercise').forEach(el => el.addEventListener('change', renderWorkouts));
            document.getElementById('logout-btn').addEventListener('click', e => { e.preventDefault(); logout(); window.location.href = 'index.html'; });

            // Initial calls
            populateDropdowns();
            renderWorkouts();
            renderCharts();
        });
    </script>
</body>
</html>
